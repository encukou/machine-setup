- hosts: localhost
  connection: local
  become_user: root
  become_method: sudo
  tasks:

  - name: Set up user groups
    become: yes
    group:
      name: '{{ item }}'
      state: present
    with_items: &my-user-groups
      - wheel
      - dialout
      - docker
      - mock
  - name: Add myself to groups
    become: yes
    user:
      name: pviktori
      groups: *my-user-groups

  - name: Set up $HOME directory structure 
    file:
      path: '~/{{ item }}'
      state: directory
    with_items:
      - dev
      - tmp
      - .local/share/gnome-shell/extensions

  - name: Install useful software
    become: yes
    dnf:
      name: '{{ item }}'
      state: latest
    with_items:
      - python3
      - git
      - gitk
      - tmux
      - nano
      - exa
      - neovim
      - gedit
      - geany
      - firefox
      - gnome-terminal
      - sqlitebrowser
      
      - quassel-client
      - thunderbird
      - audacity
      
      # tools for further configuration
      - python3dist(psutil)  # for dconf
      - python3dist(click)
      - /usr/bin/unzip
      - /usr/bin/wget

  - name: Install Firefox extensions (system-wide)
    set_fact:
      ff_dir: /usr/share/mozilla/extensions/{ec8030f7-c20a-464f-9b0e-13a3a9e97384}/
  - name: Install Firefox extensions
    become: yes
    shell: |
      cd /usr/share/mozilla/extensions/{ec8030f7-c20a-464f-9b0e-13a3a9e97384}/
      mkdir {{ item.name }}
      cd {{ item.name }}
      wget -O __extension.xpi {{ item.url }}
      unzip __extension.xpi
      rm __extension.xpi
    args:
      creates: '/usr/share/mozilla/extensions/{ec8030f7-c20a-464f-9b0e-13a3a9e97384}//{{ item.name }}'
    with_items:
       - label: uMatrix
         name: uMatrix@raymondhill.net
         url: https://github.com/gorhill/uMatrix/releases/download/1.3.2/uMatrix.webext.xpi
       - label: Tab Containers
         name: "@testpilot-containers"
         url: https://github.com/mozilla/multi-account-containers/releases/download/5.0.1/multi-account-containers-5.0.1.xpi
       - label: Tree Style Tab
         name: treestyletab@piro.sakura.ne.jp
         url: https://addons.mozilla.org/firefox/downloads/file/858399/tree_style_tab-2.4.11-an+fx-linux.xpi
    loop_control:
      label: "{{ item.label }}"

  - name: Set up directories for auto-opening Geany projects
    file:
      name: "{{ item }}"
      state: directory
    with_items:
      - ~/.local/etc/geany.projects
      - ~/.local/var/run/geany.sockets
  - name: Create a Geany project for each workspace
    template:
      src: geany-project.template
      dest: ~/.local/etc/geany.projects/auto-{{ item.0 }}.geany
      force: no
    with_indexed_items: &workspace-names
      - com
      - www
      - rht
      - mpt
      - pvc
      - py3
      - cpy
      - pyl
      - abc
      - xyz
      - prz
      - fun

  - name: Set workspace names
    set_fact:
      workspace_names: *workspace-names
  - name: Debug workspace names
    dconf:
      key: /org/gnome/desktop/wm/preferences/workspace-names
      state: present
      value: |
        [{% for wn in workspace_names %}'{{ wn }}'{% if not loop.last %},{% endif %}{% endfor %}]

  - name: Clone my GitHub repos
    shell: |
      # Clone anonymously
      cd ~/dev
      git clone https://github.com/encukou/{{ item }}
      cd {{ item }}
      # Set URL to SSH
      git remote set-url origin git@github.com:encukou/{{ item }}.git
    args:
      creates: '~/dev/{{ item }}'
    with_items:
      - gnome-shell-frippery
      - bin

  - name: Create symlinks in $HOME
    file:
      state: link
      src: ~/{{ item.value }}
      dest: ~/{{ item.key }}
    with_dict:
      bin: dev/bin
      .local/share/gnome-shell/extensions/Bottom_Panel@rmy.pobox.com: dev/gnome-shell-frippery/extensions/Bottom_Panel@rmy.pobox.com

  - name: Source bashrc-extra at end of .bashrc
    lineinfile:
      path: '~/.bashrc'
      line: ". ~/bin/bashrc-extra"

